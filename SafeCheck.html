<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>8 February 2027's Call - SafeCheck</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Icône -->
    <link rel="icon" type="image/png" href="827scall Logo (Carré).png">

    <!-- Police titres : Inndam Extended (à adapter selon votre hébergement) -->
    <style>
        @font-face {
            font-family: "Inndam Extended";
            src: local("Inndam Extended"), local("Inndam-Extended");
            /* Ajoutez ici src: url("InndamExtended.woff2") format("woff2"); si vous avez le fichier */
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg: #050608;
            --bg-alt: #0b0d12;
            --border: #20232b;
            --accent: #0f0;
            --accent-soft: rgba(0, 255, 156, 0.12);
            --accent-warn: #ffb300;
            --accent-danger: #ff1744;
            --accent-critical: #ff1744;
            --accent-unknown: #ff6d00;
            --text-main: #e5e7eb;
            --text-soft: #9ca3af;
            --text-muted: #6b7280;
            --step-ok: #00ff9c;
            --step-pending: #9ca3af;
            --step-running: #00bcd4;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
            color: var(--text-main);
            font-family: monospace;
            height: 100%;
        }

        body {
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        /* Intro plein écran style invite de commande */
        #intro-screen {
            position: fixed;
            inset: 0;
            background: #020617;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
        }

        #intro-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 24px;
            background-image: url("827scall Logo (Carré).png");
            background-size: cover;
            background-position: center;
            border-radius: 16px;
            box-shadow: 0 0 24px rgba(0, 76, 200, 0.39);
        }

        #intro-title {
            font-family: monospace;
            font-size: 2.827rem;
            color: var(--accent);
            letter-spacing: 0.06em;
            white-space: nowrap;
            overflow: hidden;
            border-right: 2px solid var(--accent);
            animation:
                typing 1.6s steps(20, end),
                blink-caret 0.6s step-end infinite;
        }

        #intro-sub {
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--text-soft);
        }

        #intro-matrix {
            position: absolute;
            inset: 0;
            opacity: 0.12;
            pointer-events: none;
            background-image: linear-gradient(
                    rgba(0, 255, 156, 0.0827) 1px,
                    transparent 1px
            );
            background-size: 100% 18px;
        }

        #intro-fade {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 0, #020617 70%);
            opacity: 0;
            pointer-events: none;
            animation: introFadeOut 1.8s ease-out forwards;
            animation-delay: 1.8s;
        }

        .intro-disappear {
            animation: introDisappear 0.6s ease-out forwards;
            animation-delay: 1.8s;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 39ch; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: var(--accent); }
        }

        @keyframes introFadeOut {
            0% { opacity: 0; }
            40% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        @keyframes introDisappear {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.02); visibility: hidden; }
        }

        /* Conteneur principal */
        .safecheck-root {
            width: 100%;
            max-width: 1400px;
            margin: 32px auto;
            padding: 24px 16px 40px;
        }

        .safecheck-shell {
            border-radius: 18px;
            border: 1px solid var(--border);
            background: radial-gradient(circle at top left, #111827 0, #020617 55%);
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.9),
                0 18px 45px rgba(0, 0, 0, 0.75);
            padding: 20px 22px 26px;
        }

        /* Barre pseudo-terminal */
        .shell-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .shell-dots {
            display: flex;
            gap: 8px;
        }

        .shell-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: #4b5563;
        }

        .shell-dot.red { background: #0f0; }
        .shell-dot.yellow { background: #0af; }
        .shell-dot.green { background: #827; }

        .shell-title {
            font-family: "Inndam Extended", system-ui, sans-serif;
            font-size: 0.9rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--text-soft);
        }

        .shell-status {
            font-size: 0.75rem;
            color: var(--accent);
        }

        /* En-tête SafeCheck */
        .safecheck-header {
            display: flex;
            align-items: flex-start;
            gap: 18px;
            padding: 14px 16px 18px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(8, 47, 73, 0.9));
            border: 1px solid rgba(31, 41, 55, 0.9);
            margin-bottom: 18px;
        }

        .safecheck-logo {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            background-image: url("827scall Logo (Carré).png");
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 18px rgba(0, 255, 156, 0.35);
            flex-shrink: 0;
        }

        .safecheck-header-text {
            flex: 1;
        }

        .safecheck-title {
            font-family: "Inndam Extended", system-ui, sans-serif;
            font-size: 1.4rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            margin: 0 0 4px;
            color: var(--accent);
        }

        .safecheck-subtitle {
            font-size: 0.85rem;
            color: var(--text-soft);
        }

        .safecheck-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Layout principal */
        .safecheck-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
            gap: 18px;
        }

        @media (max-width: 900px) {
            .safecheck-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        /* Panneau gauche : entrée */
        .panel {
            border-radius: 14px;
            border: 1px solid var(--border);
            background: radial-gradient(circle at top left, #020617 0, #020617 55%);
            padding: 14px 14px 16px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .panel-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-soft);
        }

        .panel-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: var(--text-muted);
        }

        .input-label {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .input-row {
            margin-bottom: 10px;
        }

        textarea.safe-input {
            width: 100%;
            min-height: 96px;
            resize: vertical;
            background: #020617;
            border-radius: 10px;
            border: 1px solid #1f2937;
            padding: 10px 11px;
            color: var(--text-main);
            font-family: monospace;
            font-size: 1rem;
            outline: none;
        }

        textarea.safe-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(0, 255, 156, 0.35);
        }

        .file-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px dashed #4b5563;
            background: #020617;
            color: var(--text-soft);
            font-size: 1rem;
            cursor: pointer;
        }

        .file-input-wrapper span {
            pointer-events: none;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-name {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .scan-button-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 6px;
        }

        .scan-button {
            padding: 7px 16px;
            border-radius: 999px;
            border: 1px solid var(--accent);
            background: radial-gradient(circle at top, var(--accent-soft) 0, #020617 60%);
            color: var(--accent);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            cursor: pointer;
        }

        .scan-button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .scan-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .scan-hint code {
            background: rgba(15, 23, 42, 0.9);
            padding: 1px 4px;
            border-radius: 4px;
            border: 1px solid #111827;
        }

        /* Étapes de scan */
        .steps {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed #1f2937;
        }

        .steps-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-soft);
        }

        .step-indicator {
            width: 9px;
            height: 9px;
            border-radius: 999px;
            background: var(--step-pending);
        }

        .step-indicator.running {
            background: var(--step-running);
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.8);
        }

        .step-indicator.done {
            background: var(--step-ok);
            box-shadow: 0 0 8px rgba(0, 255, 156, 0.8);
        }

        .step-label {
            flex: 1;
        }

        .step-latency {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Panneau droit : résultats */
        .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 1.0827rem;
            border: 1px solid #374151;
            background: #020617;
        }

        .risk-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--text-muted);
        }

        .risk-label {
            text-transform: uppercase;
            letter-spacing: 0.16em;
        }

        .risk-safe .risk-dot { background: #0f0; }
        .risk-normal .risk-dot { background: #ff0; }
        .risk-danger .risk-dot { background: #f30; }
        .risk-malware .risk-dot { background: #f00; }
        .risk-unknown-normal .risk-dot { background: #fa0; }
        .risk-unknown-suspect .risk-dot { background: #ff2027; }

        .risk-malware {
            animation: blink-critical 0.24s step-end infinite;
        }

        .risk-unknown-suspect {
            animation: blink-unknown 0.36s step-end infinite;
        }

        @keyframes blink-critical {
            0%, 100% { border-color: rgba(255, 0, 0, 0.9); box-shadow: 0 0 76px rgba(255, 1, 1, 0.9); }
            51%, 100% { border-color: #fff; box-shadow: none; }
        }

        @keyframes blink-unknown {
            0%, 76% { border-color: rgba(255, 127, 0, 0.9); box-shadow: 0 0 64px rgba(255, 127, 0, 0.9); }
            51%, 100% { border-color: #fff; box-shadow: none; }
        }

        .risk-summary {
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-soft);
        }

        .risk-summary strong {
            color: var(--accent);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
            gap: 10px;
            margin-top: 12px;
        }

        @media (max-width: 900px) {
            .analysis-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .analysis-block {
            border-radius: 10px;
            border: 1px solid #111827;
            background: #020617;
            padding: 8px 9px;
        }

        .analysis-title {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .analysis-content {
            font-size: 1rem;
            color: var(--text-soft);
            max-height: 140px;
            overflow: auto;
            white-space: pre-wrap;
        }

        .analysis-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid #1f2937;
            font-size: 1rem;
            margin: 2px 4px 2px 0;
        }

        .analysis-tag.safe { border-color: #0f0; color: #2f2; }
        .analysis-tag.warn { border-color: #ff0; color: #facc15; }
        .analysis-tag.danger { border-color: #f03; color: #f23; }
        .analysis-tag.unknown { border-color: #fa0; color: #fb923c; }

        .analysis-raw {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .analysis-raw code {
            background: #020617;
            border-radius: 4px;
            border: 1px solid #111827;
            padding: 2px 4px;
        }

        /* Popups */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 998;
        }

        .modal {
            width: 100%;
            max-width: 460px;
            border-radius: 16px;
            border: 1px solid #4b5563;
            background: #020617;
            padding: 18px 18px 16px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.9);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .modal-icon {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .modal-title {
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
        }

        .modal-body {
            font-size: 1rem;
            color: var(--text-soft);
            margin-bottom: 10px;
        }

        .modal-body ul {
            padding-left: 18px;
            margin: 6px 0;
        }

        .modal-body li {
            margin-bottom: 6px;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: #020617;
            color: var(--text-soft);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .btn-primary {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-danger {
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        .modal-warning .modal-icon {
            background: rgba(250, 204, 21, 0.12);
            border: 1px solid #facc15;
            color: #facc15;
        }

        .modal-warning .modal-title {
            color: #facc15;
        }

        .modal-critical .modal-icon {
            background: rgba(248, 113, 113, 0.12);
            border: 1px solid #ef4444;
            color: #ef4444;
            animation: blink-critical 0.36s step-end infinite;
        }

        .modal-critical .modal-title {
            color: #ef4444;
        }

        .modal-countdown {
            font-size: 1.2rem;
            color: #f97373;
            margin-top: 6px;
        }

        .modal-countdown strong {
            color: #fca5a5;
        }

        /* Ligne de bas de page */
        .footer-line {
            margin-top: 18px;
            padding-top: 10px;
            border-top: 1px dashed #1f2937;
            font-size: 1rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .footer-line span {
            white-space: nowrap;
        }

        .footer-line code {
            background: #020617;
            border-radius: 4px;
            border: 1px solid #111827;
            padding: 1px 4px;
        }
    </style>
</head>
<body>

<!-- INTRO SAFE CHECK -->
<div id="intro-screen">
    <div id="intro-matrix"></div>
    <div id="intro-fade"></div>
    <div id="intro-logo"></div>
    <div id="intro-title">8 February 2027's Call - SafeCheck </div>
    <div id="intro-sub">Invite de commande de sécurité — Analyse 3 étapes (texte, fichier, global)</div>
</div>

<!-- CONTENU PRINCIPAL -->
<div class="safecheck-root" id="safecheck-root" style="visibility:hidden; opacity:0; transition:opacity 0.4s ease-out;">
    <div class="safecheck-shell">
        <div class="shell-header">
            <div class="shell-dots">
                <div class="shell-dot red"></div>
                <div class="shell-dot yellow"></div>
                <div class="shell-dot green"></div>
            </div>
            <div class="shell-title">827 : SAFECHECK / COMMUNITY TOOL</div>
            <div class="shell-status" id="shell-status">IDLE ▌</div>
        </div>

        <div class="safecheck-header">
            <div class="safecheck-logo"></div>
            <div class="safecheck-header-text">
                <h1 class="safecheck-title">8 February 2027's Call</h1>
                <div class="safecheck-subtitle">
                    Interface de vérification de liens et fichiers — pensée pour la communauté, sans publicité, sans tracking.
                    <br>Scan en 3 étapes : texte, sandbox, analyse globale.
                </div>
                <div class="safecheck-meta">
                    Moteur : filtres de mots-clés, caractères suspects, extensions, TLD à risque, encodages anormaux.
                    Connectable à un backend antivirus / sandbox spécialisé.
                </div>
            </div>
        </div>

        <div class="safecheck-layout">
            <!-- PANNEAU GAUCHE : ENTRÉE -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Entrée à analyser</div>
                    <div class="panel-badge">Texte + Fichier</div>
                </div>

                <div class="input-row">
                    <div class="input-label">Zone de texte (lien suspect ou contenu brut)</div>
                    <textarea id="inputText" class="safe-input" placeholder="Colle ici un lien ou un texte à analyser (ex : https://google.com, https://facebook.com, lien raccourci, etc.)"></textarea>
                </div>

                <div class="file-row">
                    <label class="file-input-wrapper">
                        <span>Importer un fichier (tout type)</span>
                        <input type="file" id="fileInput">
                    </label>
                    <div class="file-name" id="fileName">Aucun fichier sélectionné</div>
                </div>

                <div class="scan-button-row">
                    <button class="scan-button" id="scanButton">Lancer le scan</button>
                    <div class="scan-hint">
                        Latence étape 1 ≤ <code>50 ms</code> — les étapes 2 et 3 peuvent prendre plus de temps (sandbox / backend).
                    </div>
                </div>

                <div class="steps">
                    <div class="steps-row">
                        <div class="step">
                            <div class="step-indicator" id="step1-indicator"></div>
                            <div class="step-label">Étape 1 — Scan du texte / nom de fichier (mots-clés, TLD, encodages)</div>
                            <div class="step-latency" id="step1-latency">– ms</div>
                        </div>
                        <div class="step">
                            <div class="step-indicator" id="step2-indicator"></div>
                            <div class="step-label">Étape 2 — Scan sandbox / backend (visualisation sans l'utilisateur)</div>
                            <div class="step-latency" id="step2-latency">– ms</div>
                        </div>
                        <div class="step">
                            <div class="step-indicator" id="step3-indicator"></div>
                            <div class="step-label">Étape 3 — Analyse globale et classification du risque</div>
                            <div class="step-latency" id="step3-latency">– ms</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PANNEAU DROIT : RÉSULTATS -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Résultat du scan</div>
                    <div class="panel-badge" id="scanModeBadge">En attente</div>
                </div>

                <div id="riskBadge" class="risk-badge">
                    <div class="risk-dot"></div>
                    <div class="risk-label" id="riskLabel">Aucun scan</div>
                </div>

                <div class="risk-summary" id="riskSummary">
                    En attente d'un scan. Colle un lien ou importe un fichier, puis lance l'analyse.
                </div>

                <div class="analysis-grid">
                    <div class="analysis-block">
                        <div class="analysis-title">Mots-clés & caractères détectés</div>
                        <div class="analysis-content" id="keywordAnalysis">
                            Aucun mot-clé analysé pour l'instant.
                        </div>
                    </div>
                    <div class="analysis-block">
                        <div class="analysis-title">Extensions / TLD / encodages</div>
                        <div class="analysis-content" id="extensionAnalysis">
                            Aucune extension ou TLD analysé pour l'instant.
                        </div>
                    </div>
                </div>

                <div class="analysis-block" style="margin-top:10px;">
                    <div class="analysis-title">Trace brute de l'analyse</div>
                    <div class="analysis-content analysis-raw" id="rawAnalysis">
                        <code>// En attente de données…</code>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-line">
            <span>827 : SafeCheck — Communauté "8 February 2027's Call"</span>
            <span>Règles : <code>Safe</code>, <code>Normal</code>, <code>Dangereux</code>, <code>Virus/Malware</code>, <code>Inconnu-Normal</code>, <code>Inconnu-Suspect</code></span>
        </div>
    </div>
</div>

<!-- MODAL DANGER / INCONNU-NORMAL -->
<div class="modal-backdrop" id="modalWarningBackdrop">
    <div class="modal modal-warning">
        <div class="modal-header">
            <div class="modal-icon">!</div>
            <div class="modal-title">Alerte de sécurité</div>
        </div>
        <div class="modal-body" id="modalWarningBody">
            Le lien ou fichier analysé présente un risque <strong>Dangereux</strong> ou <strong>Inconnu mais Normal</strong>.
            <ul>
                <li>Évite de cliquer ou d'ouvrir ce contenu sans vérification supplémentaire.</li>
                <li>Vérifie la source, le contexte et l'expéditeur.</li>
                <li>Si tu as un doute, considère ce contenu comme non fiable.</li>
            </ul>
        </div>
        <div class="modal-footer">
            <button class="btn" id="modalWarningClose">Fermer</button>
        </div>
    </div>
</div>

<!-- MODAL CRITIQUE / MALWARE / INCONNU-SUSPECT -->
<div class="modal-backdrop" id="modalCriticalBackdrop">
    <div class="modal modal-critical">
        <div class="modal-header">
            <div class="modal-icon">!</div>
            <div class="modal-title">Alerte critique</div>
        </div>
        <div class="modal-body" id="modalCriticalBody">
            Le lien ou fichier analysé est classé <strong>VIRUS / MALWARE</strong> ou <strong>Inconnu mais Suspect</strong>.
            <ul>
                <li>Ne clique pas sur ce lien et n'ouvre pas ce fichier.</li>
                <li>Supprime-le de ton appareil si possible.</li>
                <li>Ne le transfère pas à d'autres personnes.</li>
                <li>Utilise un antivirus ou un outil de sécurité pour un nettoyage complet.</li>
            </ul>
            <div class="modal-countdown">
                Suppression logique dans <strong id="criticalCountdown">30</strong> secondes (dans cette interface).
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" id="modalCriticalCancel">Annuler la suppression</button>
            <button class="btn btn-danger" id="modalCriticalDeleteNow">Supprimer maintenant</button>
        </div>
    </div>
</div>

<script>
/* -----------------------------------------------------------
   827 : SafeCheck — JavaScript (filtres & logique de scan)
   ----------------------------------------------------------- */

(function () {
    "use strict";

    // Sélecteurs principaux
    const introScreen = document.getElementById("intro-screen");
    const root = document.getElementById("safecheck-root");
    const shellStatus = document.getElementById("shell-status");
    const inputText = document.getElementById("inputText");
    const fileInput = document.getElementById("fileInput");
    const fileNameLabel = document.getElementById("fileName");
    const scanButton = document.getElementById("scanButton");

    const step1Indicator = document.getElementById("step1-indicator");
    const step2Indicator = document.getElementById("step2-indicator");
    const step3Indicator = document.getElementById("step3-indicator");
    const step1Latency = document.getElementById("step1-latency");
    const step2Latency = document.getElementById("step2-latency");
    const step3Latency = document.getElementById("step3-latency");

    const riskBadge = document.getElementById("riskBadge");
    const riskLabel = document.getElementById("riskLabel");
    const riskSummary = document.getElementById("riskSummary");
    const scanModeBadge = document.getElementById("scanModeBadge");
    const keywordAnalysis = document.getElementById("keywordAnalysis");
    const extensionAnalysis = document.getElementById("extensionAnalysis");
    const rawAnalysis = document.getElementById("rawAnalysis");

    const modalWarningBackdrop = document.getElementById("modalWarningBackdrop");
    const modalWarningClose = document.getElementById("modalWarningClose");
    const modalCriticalBackdrop = document.getElementById("modalCriticalBackdrop");
    const modalCriticalCancel = document.getElementById("modalCriticalCancel");
    const modalCriticalDeleteNow = document.getElementById("modalCriticalDeleteNow");
    const criticalCountdownLabel = document.getElementById("criticalCountdown");

    let criticalCountdownTimer = null;
    let criticalCountdownValue = 30;

    /* Intro : disparition après animation */
    window.addEventListener("load", () => {
        setTimeout(() => {
            introScreen.classList.add("intro-disappear");
            setTimeout(() => {
                introScreen.style.display = "none";
                root.style.visibility = "visible";
                root.style.opacity = "1";
            }, 650);
        }, 2800);
    });

    /* Mise à jour du nom de fichier */
    fileInput.addEventListener("change", () => {
        if (fileInput.files && fileInput.files.length > 0) {
            fileNameLabel.textContent = fileInput.files[0].name;
        } else {
            fileNameLabel.textContent = "Aucun fichier sélectionné";
        }
    });

    /* Gestion du bouton de scan */
    scanButton.addEventListener("click", () => {
        startScan();
    });

    /* Fermer modale warning */
    modalWarningClose.addEventListener("click", () => {
        modalWarningBackdrop.style.display = "none";
    });

    /* Modale critique : annuler suppression */
    modalCriticalCancel.addEventListener("click", () => {
        stopCriticalCountdown();
        modalCriticalBackdrop.style.display = "none";
    });

    /* Modale critique : suppression immédiate */
    modalCriticalDeleteNow.addEventListener("click", () => {
        performLogicalDeletion();
    });

    /* Lancer le scan complet */
    function startScan() {
        const text = (inputText.value || "").trim();
        const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

        if (!text && !file) {
            alert("Ajoute au moins un texte/lien ou un fichier à analyser.");
            return;
        }

        resetUIForScan();
        scanButton.disabled = true;
        shellStatus.textContent = "SCANNING… ▌";

        const scanStart = performance.now();

        // Étape 1 : analyse rapide texte / nom de fichier (≤ 50 ms)
        const step1Start = performance.now();
        const step1Result = runStep1(text, file);
        const step1End = performance.now();
        const step1Duration = Math.max(1, Math.round(step1End - step1Start));
        step1Latency.textContent = step1Duration + " ms";

        // Forcer ≤ 50 ms (logique interne rapide, pas de timeout artificiel)
        if (step1Duration > 50) {
            console.warn("Étape 1 a dépassé 50 ms (", step1Duration, "ms )");
        }

        markStepDone(step1Indicator);

        // Étape 2 : appel backend / sandbox (simulé par structure, prêt à connecter)
        markStepRunning(step2Indicator);
        const step2Start = performance.now();

        runStep2Sandbox(text, file, step1Result)
            .then(step2Result => {
                const step2End = performance.now();
                const step2Duration = Math.max(1, Math.round(step2End - step2Start));
                step2Latency.textContent = step2Duration + " ms";
                markStepDone(step2Indicator);

                // Étape 3 : agrégation globale
                markStepRunning(step3Indicator);
                const step3Start = performance.now();
                const finalResult = runStep3Overall(step1Result, step2Result);
                const step3End = performance.now();
                const step3Duration = Math.max(1, Math.round(step3End - step3Start));
                step3Latency.textContent = step3Duration + " ms";
                markStepDone(step3Indicator);

                const scanEnd = performance.now();
                const totalDuration = Math.max(1, Math.round(scanEnd - scanStart));
                shellStatus.textContent = "DONE (" + totalDuration + " ms) ▌";

                updateUIWithResult(finalResult, text, file);
                scanButton.disabled = false;
            })
            .catch(err => {
                console.error("Erreur backend/sandbox :", err);
                shellStatus.textContent = "ERREUR BACKEND ▌";
                scanButton.disabled = false;
            });
    }

    /* Étape 1 : analyse rapide texte / nom de fichier */
    function runStep1(text, file) {
        const lower = text.toLowerCase();
        const hasHttps = lower.startsWith("https://");
        const hasHttp = lower.startsWith("http://");
        const hasDotCom = lower.includes(".com");
        const hasDotFr = lower.includes(".fr");

        const fileName = file ? file.name : "";
        const fileLower = fileName.toLowerCase();

        const safeExtensions = [".png", ".jpeg", ".jpg", ".mp4", ".mp3", ".m4a", ".avi", ".txt"];
        let fileExtension = "";
        let fileExtensionKnown = false;

        if (fileLower.includes(".")) {
            fileExtension = fileLower.substring(fileLower.lastIndexOf("."));
            fileExtensionKnown = safeExtensions.includes(fileExtension);
        }

        let textRiskHint = "unknown";
        if (!text) {
            textRiskHint = "none";
        } else if (hasHttps && (hasDotCom || hasDotFr)) {
            textRiskHint = "safe";
        } else if (hasHttps) {
            textRiskHint = "normal";
        } else if (!hasHttps && (hasHttp || text.length > 0)) {
            textRiskHint = "dangerous";
        }

        let fileRiskHint = "unknown";
        if (!file) {
            fileRiskHint = "none";
        } else if (fileExtensionKnown) {
            fileRiskHint = "normal";
        } else {
            fileRiskHint = "unknown-suspect";
        }

        const suspiciousTLDs = [".xyz", ".monster", ".top", ".click", ".info"];
        const suspiciousHosts = ["virus", "malware"];
        const shorteners = ["bit.ly/", "tinyurl.com/", "t.co/"];

        let tldFlag = false;
        let hostFlag = false;
        let shortenerFlag = false;
        let encodingFlag = false;
        let randomFlag = false;

        suspiciousTLDs.forEach(tld => {
            if (lower.includes(tld)) tldFlag = true;
        });

        suspiciousHosts.forEach(h => {
            if (lower.includes(h)) hostFlag = true;
        });

        shorteners.forEach(s => {
            if (lower.includes(s)) shortenerFlag = true;
        });

        const encodingMatches = lower.match(/%[0-9a-f]{2}/g);
        if (encodingMatches && encodingMatches.length > 5) {
            encodingFlag = true;
        }

        if (lower.length > 25) {
            const pathPart = lower.split("/").slice(3).join("/");
            const digits = (pathPart.match(/[0-9]/g) || []).length;
            const letters = (pathPart.match(/[a-z]/g) || []).length;
            if (digits + letters > 0) {
                const ratio = digits / (digits + letters);
                if (ratio > 0.4 && pathPart.length > 12) {
                    randomFlag = true;
                }
            }
        }

        return {
            text,
            fileName,
            fileExtension,
            textRiskHint,
            fileRiskHint,
            flags: {
                tldFlag,
                hostFlag,
                shortenerFlag,
                encodingFlag,
                randomFlag
            }
        };
    }

    /* Étape 2 : backend / sandbox (structure prête à connecter) */
    async function runStep2Sandbox(text, file, step1Result) {
        const payload = {
            text: text || null,
            fileName: file ? file.name : null,
            step1Flags: step1Result.flags
        };

        // Exemple de connexion à un backend spécialisé :
        // const response = await fetch("/api/scan", {
        //     method: "POST",
        //     headers: { "Content-Type": "application/json" },
        //     body: JSON.stringify(payload)
        // });
        // const data = await response.json();
        // return data;

        // Ici, on renvoie une structure neutre, prête à être remplacée par la vraie réponse backend.
        return {
            backendAvailable: false,
            backendRisk: "unknown",
            backendDetails: "Backend non connecté (remplace cette partie par la réponse réelle de ton antivirus / sandbox).",
            backendScore: 0
        };
    }

    /* Étape 3 : agrégation globale */
    function runStep3Overall(step1, step2) {
        const flags = step1.flags;
        let risk = "safe";
        let reason = [];

        // Règles de base sur le texte
        if (step1.textRiskHint === "dangerous") {
            risk = "dangerous";
            reason.push("Lien sans https:// détecté.");
        } else if (step1.textRiskHint === "normal") {
            risk = "normal";
            reason.push("Lien https:// sans TLD critique.");
        } else if (step1.textRiskHint === "safe") {
            risk = "safe";
            reason.push("Lien https:// avec TLD courant (.com / .fr).");
        }

        // Règles sur le fichier
        if (step1.fileRiskHint === "unknown-suspect") {
            if (risk === "safe") risk = "unknown-suspect";
            reason.push("Extension de fichier inconnue ou non listée.");
        } else if (step1.fileRiskHint === "normal") {
            reason.push("Extension de fichier connue (png, jpeg, mp4, mp3, m4a, avi, txt).");
        }

        // Flags critiques
        if (flags.tldFlag || flags.hostFlag || flags.shortenerFlag || flags.encodingFlag || flags.randomFlag) {
            if (!step1.text.toLowerCase().startsWith("https://")) {
                risk = "malware";
                reason.push("Combinaison de TLD/host/encodage suspect + absence de https://.");
            } else {
                if (risk === "safe") risk = "unknown-suspect";
                reason.push("TLD/host/encodage suspect malgré https://.");
            }
        }

        // Intégration backend (si disponible)
        if (step2.backendAvailable) {
            reason.push("Backend : " + step2.backendDetails);
            if (step2.backendRisk === "malware") {
                risk = "malware";
            } else if (step2.backendRisk === "dangerous" && risk !== "malware") {
                risk = "dangerous";
            }
        }

        // Cas "Inconnu mais Normal"
        if (risk === "safe" && (step1.textRiskHint === "none" && step1.fileRiskHint === "none")) {
            risk = "unknown-normal";
            reason.push("Aucun texte ni fichier fourni, classification par défaut.");
        }

        return {
            risk,
            reason,
            step1,
            step2
        };
    }

    /* Mise à jour UI après scan */
    function updateUIWithResult(result, text, file) {
        const risk = result.risk;
        riskBadge.className = "risk-badge";
        riskBadge.classList.add("risk-" + risk.replace(/_/g, "-"));

        let label = "";
        let summary = "";

        switch (risk) {
            case "safe":
                label = "Safe (Vert)";
                summary = "Le contenu ressemble à un lien ou fichier sûr (ex : https://google.com).";
                break;
            case "normal":
                label = "Normal (Jaune)";
                summary = "Le contenu semble standard (https://) mais reste à utiliser avec prudence.";
                break;
            case "dangerous":
                label = "Dangereux (Rouge)";
                summary = "Le contenu ne commence pas par https:// ou présente des signaux de danger.";
                break;
            case "malware":
                label = "VIRUS / MALWARE (Rouge clignotant)";
                summary = "Le contenu présente des caractéristiques typiques de malware ou de phishing agressif.";
                break;
            case "unknown-normal":
                label = "Inconnu mais Normal (Orange)";
                summary = "Le contenu n'est pas clairement dangereux, mais reste non identifié.";
                break;
            case "unknown-suspect":
                label = "Inconnu mais Suspect (Orange clignotant)";
                summary = "Le contenu est inconnu et présente des signaux suspects.";
                break;
            default:
                label = "Inconnu";
                summary = "Impossible de classifier clairement ce contenu.";
        }

        riskLabel.textContent = label;
        riskSummary.innerHTML = "<strong>Résumé :</strong> " + summary;

        if (text && file) {
            scanModeBadge.textContent = "Texte + Fichier";
        } else if (text) {
            scanModeBadge.textContent = "Texte uniquement";
        } else if (file) {
            scanModeBadge.textContent = "Fichier uniquement";
        } else {
            scanModeBadge.textContent = "Aucun contenu";
        }

        renderKeywordAnalysis(result.step1);
        renderExtensionAnalysis(result.step1);
        renderRawAnalysis(result);

        // Popups selon le risque
        if (risk === "dangerous" || risk === "unknown-normal") {
            modalWarningBackdrop.style.display = "flex";
        } else if (risk === "malware" || risk === "unknown-suspect") {
            modalCriticalBackdrop.style.display = "flex";
            startCriticalCountdown();
        }
    }

    /* Affichage mots-clés / flags */
    function renderKeywordAnalysis(step1) {
        const flags = step1.flags;
        const container = keywordAnalysis;
        container.innerHTML = "";

        if (!step1.text && !step1.fileName) {
            container.textContent = "Aucun texte ni fichier à analyser.";
            return;
        }

        const tags = [];

        if (step1.textRiskHint === "safe") {
            tags.push(createTag("https:// + .com/.fr", "safe"));
        } else if (step1.textRiskHint === "normal") {
            tags.push(createTag("https:// (autre TLD)", "warn"));
        } else if (step1.textRiskHint === "dangerous") {
            tags.push(createTag("Lien sans https://", "danger"));
        }

        if (flags.tldFlag) tags.push(createTag("TLD suspect (.xyz, .monster, .top, .click, .info)", "danger"));
        if (flags.hostFlag) tags.push(createTag("Mot-clé 'virus' / 'malware'", "danger"));
        if (flags.shortenerFlag) tags.push(createTag("Raccourcisseur (bit.ly, tinyurl, t.co)", "warn"));
        if (flags.encodingFlag) tags.push(createTag("Encodages %xx en quantité excessive", "danger"));
        if (flags.randomFlag) tags.push(createTag("Chemin avec caractères aléatoires", "danger"));

        if (tags.length === 0) {
            container.textContent = "Aucun mot-clé ou motif suspect détecté.";
        } else {
            tags.forEach(tag => container.appendChild(tag));
        }
    }

    /* Affichage extensions / TLD */
    function renderExtensionAnalysis(step1) {
        const container = extensionAnalysis;
        container.innerHTML = "";

        if (!step1.text && !step1.fileName) {
            container.textContent = "Aucune extension ni TLD à analyser.";
            return;
        }

        if (step1.fileName) {
            const ext = step1.fileExtension || "(aucune extension)";
            const tag = createTag("Fichier : " + step1.fileName + " (" + ext + ")", step1.fileRiskHint === "normal" ? "safe" : "unknown");
            container.appendChild(tag);
        }

        if (step1.text) {
            const lower = step1.text.toLowerCase();
            const tlds = [".com", ".fr", ".xyz", ".monster", ".top", ".click", ".info"];
            tlds.forEach(tld => {
                if (lower.includes(tld)) {
                    const type = (tld === ".com" || tld === ".fr") ? "safe" : "danger";
                    container.appendChild(createTag("TLD : " + tld, type));
                }
            });
        }

        if (!container.hasChildNodes()) {
            container.textContent = "Aucune extension ou TLD notable détecté.";
        }
    }

    /* Affichage trace brute */
    function renderRawAnalysis(result) {
        const lines = [];
        lines.push("// Étape 1 :");
        lines.push("texte: " + JSON.stringify(result.step1.text));
        lines.push("fichier: " + JSON.stringify(result.step1.fileName));
        lines.push("hintTexte: " + result.step1.textRiskHint);
        lines.push("hintFichier: " + result.step1.fileRiskHint);
        lines.push("flags: " + JSON.stringify(result.step1.flags));
        lines.push("");
        lines.push("// Étape 2 (backend / sandbox) :");
        lines.push("backendAvailable: " + result.step2.backendAvailable);
        lines.push("backendRisk: " + result.step2.backendRisk);
        lines.push("backendScore: " + result.step2.backendScore);
        lines.push("backendDetails: " + result.step2.backendDetails);
        lines.push("");
        lines.push("// Étape 3 :");
        lines.push("riskFinal: " + result.risk);
        lines.push("reason: " + result.reason.join(" | "));

        rawAnalysis.innerHTML = "<code>" + escapeHtml(lines.join("\n")) + "</code>";
    }

    /* Helpers UI */
    function resetUIForScan() {
        [step1Indicator, step2Indicator, step3Indicator].forEach(el => {
            el.classList.remove("running", "done");
        });
        step1Latency.textContent = "– ms";
        step2Latency.textContent = "– ms";
        step3Latency.textContent = "– ms";
        stopCriticalCountdown();
        modalWarningBackdrop.style.display = "none";
        modalCriticalBackdrop.style.display = "none";
    }

    function markStepRunning(el) {
        el.classList.remove("done");
        el.classList.add("running");
    }

    function markStepDone(el) {
        el.classList.remove("running");
        el.classList.add("done");
    }

    function createTag(label, type) {
        const span = document.createElement("span");
        span.className = "analysis-tag " + (type || "unknown");
        span.textContent = label;
        return span;
    }

    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    /* Compte à rebours critique (30 s) */
    function startCriticalCountdown() {
        stopCriticalCountdown();
        criticalCountdownValue = 30;
        criticalCountdownLabel.textContent = String(criticalCountdownValue);
        criticalCountdownTimer = setInterval(() => {
            criticalCountdownValue -= 1;
            if (criticalCountdownValue <= 0) {
                performLogicalDeletion();
            } else {
                criticalCountdownLabel.textContent = String(criticalCountdownValue);
            }
        }, 1000);
    }

    function stopCriticalCountdown() {
        if (criticalCountdownTimer) {
            clearInterval(criticalCountdownTimer);
            criticalCountdownTimer = null;
        }
    }

    /* Suppression logique du lien/fichier dans l'interface */
    function performLogicalDeletion() {
        stopCriticalCountdown();
        inputText.value = "";
        fileInput.value = "";
        fileNameLabel.textContent = "Aucun fichier sélectionné";
        modalCriticalBackdrop.style.display = "none";
        shellStatus.textContent = "CONTENU SUPPRIMÉ LOGIQUEMENT ▌";
    }

})();
</script>

</body>
</html>
